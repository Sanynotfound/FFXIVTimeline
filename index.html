<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIVæ—¥å¿—è§£æå·¥å…·</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œå¿«é€Ÿæ ·å¼å¼€å‘ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Phosphor Icons å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* Apple News é£æ ¼å®šåˆ¶ */
        :root {
            --apple-bg: #F5F5F7;
            --apple-card: #FFFFFF;
            --apple-text: #1D1D1F;
            --apple-gray: #86868B;
            --apple-blue: #0071E3;
            --apple-blue-hover: #0077ED;
        }

        body {
            background-color: var(--apple-bg);
            color: var(--apple-text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
        }

        .btn-primary {
            background-color: var(--apple-blue);
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--apple-blue-hover);
            transform: scale(1.02);
        }
        
        .btn-secondary {
            background-color: #E8E8ED;
            color: var(--apple-text);
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background-color: #D2D2D7;
        }

        /* è¡¨æ ¼åŠ¨ç”» */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6">

    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <header class="w-full max-w-4xl text-center mb-8 fade-in-up" style="animation-delay: 0.1s;">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2">FFXIVæ—¥å¿—è§£æå·¥å…·</h1>
        <p class="text-[var(--apple-gray)] text-lg font-medium">ä¸Šä¼  CSV æ—¥å¿—æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å…³é”®ä¼¤å®³æ•°æ®</p>
    </header>

    <!-- ä¸»è¦æ“ä½œåŒºåŸŸ -->
    <main class="w-full max-w-4xl space-y-6">
        
        <!-- ä¸Šä¼ å¡ç‰‡ -->
        <div class="glass-card rounded-3xl p-8 text-center transition-all duration-300 hover:shadow-lg fade-in-up" style="animation-delay: 0.2s;">
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 cursor-pointer hover:border-[var(--apple-blue)] hover:bg-blue-50/50 transition-colors group">
                <input type="file" id="file-input" accept=".csv" class="hidden">
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 bg-blue-100 text-[var(--apple-blue)] rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="ph ph-upload-simple text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  CSV æ–‡ä»¶</p>
                        <p class="text-sm text-[var(--apple-gray)] mt-1">æ”¯æŒæ ‡å‡†æˆ˜æ–—æ—¥å¿—æ ¼å¼</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœæ§åˆ¶æ  (é»˜è®¤éšè—) -->
        <div id="control-panel" class="hidden flex flex-col sm:flex-row gap-4 justify-between items-center glass-card rounded-2xl p-4 fade-in-up">
            <div class="flex items-center gap-2 text-sm text-[var(--apple-gray)]">
                <i class="ph ph-check-circle text-green-500 text-lg"></i>
                <span id="status-text">è§£ææˆåŠŸï¼Œå…±æ‰¾åˆ° 0 æ¡æ•°æ®</span>
            </div>
            <div class="flex gap-3 w-full sm:w-auto">
                <button onclick="resetAll()" class="btn-secondary flex-1 sm:flex-none px-6 py-2.5 rounded-full font-medium text-sm flex items-center justify-center gap-2">
                    <i class="ph ph-trash"></i> é‡ç½®
                </button>
                <button onclick="copyResults()" class="btn-primary flex-1 sm:flex-none px-6 py-2.5 rounded-full font-medium text-sm flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30">
                    <i class="ph ph-copy"></i> å¤åˆ¶ç»“æœ
                </button>
            </div>
        </div>

        <!-- ç»“æœé¢„è§ˆåŒºåŸŸ (é»˜è®¤éšè—) -->
        <div id="result-area" class="hidden glass-card rounded-3xl overflow-hidden fade-in-up shadow-xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50/50">
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)]">æ—¶é—´</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)]">ä¼¤å®³æ¥æº</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)]">æŠ€èƒ½åç§°</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)] text-right">åŸå§‹ä¼¤å®³ (U)</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body" class="text-sm font-medium">
                        <!-- æ•°æ®å°†æ’å…¥è¿™é‡Œ -->
                    </tbody>
                </table>
            </div>
            <!-- ç©ºçŠ¶æ€å ä½ -->
            <div id="empty-state" class="hidden p-12 text-center text-[var(--apple-gray)]">
                <i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50"></i>
                <p>æœªæ‰¾åˆ°ç¬¦åˆæ ¼å¼çš„ä¼¤å®³æ•°æ®</p>
            </div>
        </div>

    </main>

    <footer class="mt-12 text-center text-xs text-[var(--apple-gray)] opacity-60">
        <p>Design by å‘èŠ½åœŸè±†ğŸŒ± Â· æ•°æ®å¯èƒ½å­˜åœ¨åå·®ï¼Œä¸€åˆ‡ä»¥å®æˆ˜ä¸ºå‡†ã€‚</p>
    </footer>

    <!-- æç¤ºæ¡† Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 transition-all duration-300 opacity-0 translate-y-10 z-50 pointer-events-none">
        <i class="ph ph-check-circle text-green-400 text-lg"></i>
        <span id="toast-msg" class="text-sm font-medium">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // æ ¸å¿ƒè§£æé€»è¾‘
        let parsedData = [];

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const controlPanel = document.getElementById('control-panel');
        const resultArea = document.getElementById('result-area');
        const tableBody = document.getElementById('result-table-body');
        const statusText = document.getElementById('status-text');
        const emptyState = document.getElementById('empty-state');

        // CSVè¡Œè§£æå™¨ (å¤„ç†å¼•å·)
        function parseCSVLine(text) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(cell);
                    cell = '';
                } else {
                    cell += char;
                }
            }
            result.push(cell);
            return result.map(c => c.replace(/^"|"$/g, '').trim()); // å»é™¤é¦–å°¾å¼•å·
        }

        // è§£æå•è¡Œäº‹ä»¶é€»è¾‘
        function parseEventString(time, eventStr) {
            // 1. è¿‡æ»¤æ‰ "prepares"
            if (eventStr.includes("prepares")) return null;

            // 2. æå–åŸå§‹ä¼¤å®³ (U: value)
            const rawMatch = eventStr.match(/\(U:\s*([\d,]+)/);
            if (!rawMatch) return null; // å¦‚æœæ²¡æœ‰åŸå§‹ä¼¤å®³Uå€¼ï¼Œè¯´æ˜ä¸æ˜¯æˆ‘ä»¬è¦çš„è¡Œ
            
            const rawDamage = rawMatch[1]; // ä¾‹å¦‚ "51684" æˆ– "115,962"

            // 3. æ¸…ç†å­—ç¬¦ä¸²ï¼Œä¾¿äºåˆ†å‰²
            // æˆªå–ç¬¬ä¸€ä¸ªå·¦æ‹¬å·ä¹‹å‰çš„å†…å®¹ï¼Œè¿™å°±æ˜¯æ ¸å¿ƒäº‹ä»¶æè¿°
            let mainPart = eventStr.split('(')[0].trim();
            
            // 4. åˆ†å‰²å•è¯
            // ç¤ºä¾‹: "å“å¼‚çš„æ‚²å¯‚ 13 å‡ºè¡€ ç›å¡å·´å¡ Tick 11402"
            // ç¤ºä¾‹: "è¢«ä¾µèš€çš„é£Ÿç½ªçµ 1 å‡€ç½ªä¹‹ç¯ ç›å¡å·´å¡ 46515"
            let parts = mainPart.split(/\s+/);
            
            if (parts.length < 3) return null; // æ ¼å¼å¤ªçŸ­

            // å€’åºè§£ææ³•
            let actualDamage = parts.pop();
            
            // å¤„ç† "Tick" æƒ…å†µ
            // å¦‚æœæœ€åä¸€ä¸ªæ˜¯æ•°å­—ï¼Œå€’æ•°ç¬¬äºŒä¸ªæ˜¯ Tickï¼Œæˆ–è€…å½“å‰å°±æ˜¯ Tick (è™½ç„¶ä¸€èˆ¬ Tick åè·Ÿæ•°å­—)
            if (parts.length > 0 && parts[parts.length - 1] === 'Tick') {
                actualDamage = 'Tick ' + actualDamage;
                parts.pop(); // ç§»é™¤ 'Tick'
            }

            // æ­¤æ—¶ parts æ•°ç»„å‰©ä¸‹çš„æœ€åä¸€ä¸ªå…ƒç´ åº”è¯¥æ˜¯ ç©å®¶å (Target)
            const target = parts.pop();

            // å†å‰©ä¸‹çš„æœ€åä¸€ä¸ªå…ƒç´ åº”è¯¥æ˜¯ æŠ€èƒ½å (Skill)
            // å‡è®¾æŠ€èƒ½åæ²¡æœ‰ç©ºæ ¼ (æ ¹æ®ç¤ºä¾‹ï¼šå‡€ç½ªä¹‹ç¯, å‡ºè¡€, æ·±æ¸Šæå…‰)
            const skill = parts.pop();

            // å‰©ä¸‹æ‰€æœ‰çš„éƒ¨åˆ†ç»„åˆèµ·æ¥å°±æ˜¯ ä¼¤å®³æ¥æº (Source)
            // ä¼¤å®³æ¥æºå¯èƒ½æœ‰ç©ºæ ¼ (å¦‚ï¼šè¢«ä¾µèš€çš„é£Ÿç½ªçµ 1)
            const source = parts.join(' ');

            if (!source || !skill) return null;

            return {
                time: time,
                source: source,
                skill: skill,
                rawDamage: rawDamage
            };
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                parsedData = [];

                // ä»ç¬¬1è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰
                // ç®€å•çš„åˆ¤æ–­ï¼šå¦‚æœç¬¬ä¸€åˆ—æ˜¯ "Time" åˆ™è·³è¿‡
                let startIndex = 0;
                if (lines[0] && lines[0].includes("Time") && lines[0].includes("Event")) {
                    startIndex = 1;
                }

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = parseCSVLine(line);
                    if (cols.length < 2) continue;

                    const time = cols[0];
                    const eventStr = cols[1];

                    const result = parseEventString(time, eventStr);
                    if (result) {
                        parsedData.push(result);
                    }
                }

                renderTable();
            };

            reader.readAsText(file, 'UTF-8'); // å‡è®¾æ˜¯ UTF-8ï¼Œå¦‚æœæ˜¯ä¸­æ–‡ä¹±ç å¯èƒ½éœ€è¦ GBK
        }

        function renderTable() {
            tableBody.innerHTML = '';
            
            if (parsedData.length === 0) {
                controlPanel.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                emptyState.classList.remove('hidden');
                statusText.innerText = "æœªæ‰¾åˆ°ç¬¦åˆçš„æ•°æ®";
                return;
            }

            controlPanel.classList.remove('hidden');
            resultArea.classList.remove('hidden');
            emptyState.classList.add('hidden');
            statusText.innerText = `è§£ææˆåŠŸï¼Œç”Ÿæˆ ${parsedData.length} æ¡æ•°æ®`;

            parsedData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-blue-50/30 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 text-[var(--apple-text)] tabular-nums">${row.time}</td>
                    <td class="p-4 text-[var(--apple-text)] font-medium">${row.source}</td>
                    <td class="p-4 text-[var(--apple-text)]"><span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${row.skill}</span></td>
                    <td class="p-4 text-[var(--apple-text)] text-right font-bold tabular-nums">${row.rawDamage}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // å¤åˆ¶åŠŸèƒ½
        function copyResults() {
            if (parsedData.length === 0) {
                showToast("æ²¡æœ‰æ•°æ®å¯å¤åˆ¶", "error");
                return;
            }

            // æ„å»º Header
            let text = "æ—¶é—´\tä¼¤å®³æ¥æº\tæŠ€èƒ½åç§°\tåŸå§‹ä¼¤å®³\n";
            // æ„å»º Rows
            parsedData.forEach(row => {
                text += `${row.time}\t${row.source}\t${row.skill}\t${row.rawDamage}\n`;
            });

            // æ‰§è¡Œå¤åˆ¶
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            } catch (err) {
                showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
            }
            
            document.body.removeChild(textarea);
        }

        function resetAll() {
            parsedData = [];
            fileInput.value = '';
            controlPanel.classList.add('hidden');
            resultArea.classList.add('hidden');
        }

        // äº¤äº’é€»è¾‘
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        // æ‹–æ‹½æ”¯æŒ
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-blue-50', 'border-[var(--apple-blue)]');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-[var(--apple-blue)]');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-[var(--apple-blue)]');
            if (e.dataTransfer.files.length > 0) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        // æç¤ºæ¡†é€»è¾‘
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            const icon = toast.querySelector('i');
            
            msg.innerText = message;
            if (type === 'error') {
                icon.className = 'ph ph-warning-circle text-red-400 text-lg';
            } else {
                icon.className = 'ph ph-check-circle text-green-400 text-lg';
            }

            toast.classList.remove('opacity-0', 'translate-y-10');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 2500);
        }
    </script>
</body>
</html>