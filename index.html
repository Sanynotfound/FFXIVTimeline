<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFXIVæ—¥å¿—è§£æå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --apple-bg: #F5F5F7;
            --apple-text: #1D1D1F;
            --apple-gray: #86868B;
            --apple-blue: #0071E3;
            --apple-blue-hover: #0077ED;
        }

        body {
            background-color: var(--apple-bg);
            color: var(--apple-text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
        }

        .btn-primary {
            background-color: var(--apple-blue);
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--apple-blue-hover);
            transform: scale(1.02);
        }
        
        .btn-secondary {
            background-color: #E8E8ED;
            color: var(--apple-text);
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background-color: #D2D2D7;
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6">

    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <header class="w-full max-w-5xl text-center mb-8 fade-in-up" style="animation-delay: 0.1s;">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2">FFXIVæ—¥å¿—è§£æå·¥å…·</h1>
        <!-- 3. æ¢å¤å‰¯æ ‡é¢˜ -->
        <p class="text-[var(--apple-gray)] text-lg font-medium">ä¸Šä¼  CSV æ—¥å¿—æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å…³é”®ä¼¤å®³æ•°æ®</p>
    </header>

    <!-- ä¸»è¦æ“ä½œåŒºåŸŸ -->
    <main class="w-full max-w-5xl space-y-6">
        
        <!-- ä¸Šä¼ å¡ç‰‡ -->
        <div class="glass-card rounded-3xl p-8 text-center transition-all duration-300 hover:shadow-lg fade-in-up" style="animation-delay: 0.2s;">
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 cursor-pointer hover:border-[var(--apple-blue)] hover:bg-blue-50/50 transition-colors group">
                <input type="file" id="file-input" accept=".csv" class="hidden">
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-16 h-16 bg-blue-100 text-[var(--apple-blue)] rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="ph ph-upload-simple text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-lg font-semibold">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  CSV æ–‡ä»¶</p>
                        <!-- 4. ä¿®æ”¹ä¸Šä¼ æ–‡æ¡ˆ -->
                        <p class="text-sm text-[var(--apple-gray)] mt-1">æ”¯æŒæ ‡å‡†æˆ˜æ–—æ—¥å¿—æ ¼å¼</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœæ§åˆ¶æ  -->
        <div id="control-panel" class="hidden flex flex-col sm:flex-row gap-4 justify-between items-center glass-card rounded-2xl p-4 fade-in-up">
            <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-4 text-sm text-[var(--apple-gray)]">
                <div class="flex items-center gap-1">
                    <i class="ph ph-check-circle text-green-500 text-lg"></i>
                    <span id="status-text">è§£æå®Œæˆ</span>
                </div>
                <div id="player-badge" class="hidden px-2 py-0.5 bg-blue-100 text-blue-700 rounded-md font-medium text-xs">
                    ç©å®¶: <span id="player-name-display">--</span>
                </div>
            </div>
            <div class="flex gap-3 w-full sm:w-auto">
                <button onclick="resetAll()" class="btn-secondary flex-1 sm:flex-none px-6 py-2.5 rounded-full font-medium text-sm flex items-center justify-center gap-2">
                    <i class="ph ph-trash"></i> é‡ç½®
                </button>
                <button onclick="copyResults()" class="btn-primary flex-1 sm:flex-none px-6 py-2.5 rounded-full font-medium text-sm flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30">
                    <i class="ph ph-copy"></i> å¤åˆ¶ç»“æœ
                </button>
            </div>
        </div>

        <!-- ç»“æœé¢„è§ˆåŒºåŸŸ -->
        <div id="result-area" class="hidden glass-card rounded-3xl overflow-hidden fade-in-up shadow-xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50/50">
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)] w-32">æ—¶é—´</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)]">ä¼¤å®³æ¥æº</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)]">æŠ€èƒ½åç§°</th>
                            <th class="p-4 text-xs font-bold uppercase tracking-wider text-[var(--apple-gray)] text-right">å®é™…ä¼¤å®³ (U)</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body" class="text-sm font-medium">
                        <!-- æ•°æ®å°†æ’å…¥è¿™é‡Œ -->
                    </tbody>
                </table>
            </div>
            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="hidden p-12 text-center text-[var(--apple-gray)]">
                <i class="ph ph-magnifying-glass text-4xl mb-2 opacity-50"></i>
                <p>æœªæ‰¾åˆ°ç¬¦åˆæ ¼å¼çš„ä¼¤å®³æ•°æ®</p>
            </div>
        </div>

        <!-- 1. ä½¿ç”¨è¯´æ˜å¡ç‰‡ç§»åŠ¨åˆ°åº•éƒ¨ï¼Œå¹¶ä¸ä¸Šæ–¹å®¹å™¨å®½åº¦ä¸€è‡´ -->
        <div class="glass-card rounded-2xl p-4 md:p-6 text-left w-full border border-blue-100/50 fade-in-up" style="animation-delay: 0.3s;">
            <h3 class="text-sm font-bold text-[var(--apple-blue)] uppercase tracking-wide mb-2 flex items-center gap-2">
                <i class="ph ph-info"></i> ä½¿ç”¨è¯´æ˜
            </h3>
            <ol class="list-decimal list-inside text-sm text-[var(--apple-text)] space-y-1.5 leading-relaxed">
                <!-- 2. è¯´æ˜æ–‡æœ¬ä¿®æ”¹ -->
                <li>æ‰“å¼€ <span class="font-medium bg-gray-200 px-1 rounded">fflogs.com</span>ï¼Œè¿›å…¥æˆ˜æ–—è®°å½•é¡µé¢ã€‚</li>
                <li>ç‚¹å‡» <span class="font-medium bg-gray-200 px-1 rounded">å—åˆ°ä¼¤å®³ (Damage Taken)</span> é€‰é¡¹å¡ã€‚</li>
                <li>åœ¨ <span class="font-medium bg-gray-200 px-1 rounded">äº‹ä»¶ (Events)</span> è§†å›¾ä¸­ï¼Œç­›é€‰ç‰¹å®šçš„å•åç©å®¶ã€‚</li>
                <li>ç‚¹å‡»é¡µé¢åº•éƒ¨çš„ <span class="font-medium bg-gray-200 px-1 rounded">CSV</span> æŒ‰é’®å¯¼å‡ºæ–‡ä»¶ã€‚</li>
                <li>å°†å¯¼å‡ºçš„ CSV æ–‡ä»¶æ‹–å…¥ä¸Šæ–¹åŒºåŸŸå³å¯è§£æã€‚</li>
            </ol>
        </div>

    </main>

    <footer class="mt-auto py-8 text-center text-xs text-[var(--apple-gray)] opacity-60">
        <p>Design by å‘èŠ½åœŸè±†ğŸŒ± Â· æ•°æ®å¯èƒ½å­˜åœ¨åå·®ï¼Œä¸€åˆ‡ä»¥å®é™…ä¸ºå‡†ã€‚</p>
    </footer>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 transition-all duration-300 opacity-0 translate-y-10 z-50 pointer-events-none">
        <i class="ph ph-check-circle text-green-400 text-lg"></i>
        <span id="toast-msg" class="text-sm font-medium">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        let parsedRows = [];
        let detectedPlayerName = "";
        let knownSkills = new Set(["Combined DoTs"]); // é¢„è®¾ç³»ç»ŸæŠ€èƒ½å

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const controlPanel = document.getElementById('control-panel');
        const resultArea = document.getElementById('result-area');
        const tableBody = document.getElementById('result-table-body');
        const statusText = document.getElementById('status-text');
        const emptyState = document.getElementById('empty-state');
        const playerBadge = document.getElementById('player-badge');
        const playerNameDisplay = document.getElementById('player-name-display');

        // CSV è¡Œè§£æ (å¤„ç†å¼•å·)
        function parseCSVLine(text) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(cell); cell = '';
                } else cell += char;
            }
            result.push(cell);
            return result.map(c => c.replace(/^"|"$/g, '').trim());
        }

        // æ­¥éª¤1: é¢„æ‰«æ - å¯»æ‰¾ç©å®¶IDå’ŒæŠ€èƒ½åº“
        function preScanFile(lines) {
            detectedPlayerName = "";
            knownSkills = new Set(["Combined DoTs"]);
            
            // ç®€å•çš„ç»Ÿè®¡ï¼Œä»¥é˜²æœ‰å¤šä¸ª on Target çš„æƒ…å†µï¼Œå–å‡ºç°æœ€å¤šçš„
            const playerCounts = {};

            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if (cols.length < 2) return;
                const eventStr = cols[1];

                // åŒ¹é…: Source prepares Skill on Player ...
                // è¿™é‡Œçš„æ­£åˆ™å‡è®¾ ... prepares (æŠ€èƒ½) on (ç©å®¶) æ•°å­— ...
                const prepMatch = eventStr.match(/ prepares\s+(.*?)\s+on\s+(.*?)\s+\d/);
                if (prepMatch) {
                    const skill = prepMatch[1].trim();
                    const player = prepMatch[2].trim();
                    knownSkills.add(skill);
                    
                    playerCounts[player] = (playerCounts[player] || 0) + 1;
                }
            });

            // ç¡®å®šç©å®¶å (å–å‡ºç°æ¬¡æ•°æœ€å¤šçš„ï¼Œæˆ–è€…å”¯ä¸€çš„)
            let maxCount = 0;
            for (const [player, count] of Object.entries(playerCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    detectedPlayerName = player;
                }
            }
            
            console.log("Detected Player:", detectedPlayerName);
            console.log("Learned Skills:", knownSkills);
        }

        // æ­¥éª¤2: è§£æå•è¡Œ (æ ¸å¿ƒé€»è¾‘)
        function parseLine(time, eventStr) {
            // å¿…é¡»æœ‰ U å€¼æ‰æ˜¯ä¼¤å®³è¡Œ (Combined DoTs çš„ Summary è¡Œä¹Ÿæœ‰ Uï¼Œä½†æˆ‘ä»¬ç¨åå¤„ç†)
            const uMatch = eventStr.match(/\(U:\s*([\d,]+)/);
            if (!uMatch) return null;
            
            const rawU = parseInt(uMatch[1].replace(/,/g, ''), 10);

            // ç§»é™¤ (U:...) åŠå…¶åé¢çš„å†…å®¹ï¼Œè¿˜æœ‰ (A:...)
            // ä¾‹å­: ... 11402 (A: 13986) (U: 34780)... -> ... 11402
            let cleanStr = eventStr.split(/\(U:/)[0];
            cleanStr = cleanStr.replace(/\(A:.*?\)/g, '').trim();

            // å¦‚æœæ²¡æœ‰æ¢æµ‹åˆ°ç©å®¶åï¼Œå°è¯•æœ€åçš„å…œåº•é€»è¾‘(å‡è®¾ç©ºæ ¼åˆ†å‰²)
            if (!detectedPlayerName) {
                // è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸å®‰å…¨çš„å…œåº•ï¼Œä½†åœ¨æ²¡ scan åˆ° prepares æ—¶åªèƒ½è¿™æ ·
                const parts = cleanStr.split(/\s+/);
                const damagePart = parts.pop();
                const playerPart = parts.pop(); 
                // åªèƒ½å‡è®¾å€’æ•°ç¬¬äºŒä¸ªæ˜¯ç©å®¶
                return { time, source: "Unknown", skill: "Unknown", player: playerPart, rawU, isTick: damagePart.includes("Tick"), damageText: damagePart };
            }

            // ä½¿ç”¨ç©å®¶åä½œä¸ºé”šç‚¹è¿›è¡Œåˆ†å‰²
            // Event: Source [prepares] Skill [on] Player Damage
            // Combined: Multiple Enemies Combined DoTs Player Tick Damage
            // Standard: Source Skill Player Damage
            
            // æˆ‘ä»¬åªå…³å¿ƒ"è¾“å‡ºè¡Œ"ï¼Œå³æ²¡æœ‰ "prepares" çš„è¡Œ (é™¤äº† Combined DoTs çš„ summary è¡Œ)
            // ä½†æ˜¯ Combined DoTs ä¹Ÿæ²¡æœ‰ preparesã€‚
            
            if (eventStr.includes(" prepares ")) return null; // å¿½ç•¥å‡†å¤‡è¡Œ

            // å¯»æ‰¾ç©å®¶åçš„ä½ç½®
            const playerIndex = cleanStr.indexOf(detectedPlayerName);
            if (playerIndex === -1) return null; // è¿™ä¸€è¡Œæ²¡æœ‰å½“å‰ç©å®¶ï¼Œè·³è¿‡

            // åˆ‡å‰²
            const leftPart = cleanStr.substring(0, playerIndex).trim(); // æ¥æº + æŠ€èƒ½
            const rightPart = cleanStr.substring(playerIndex + detectedPlayerName.length).trim(); // ä¼¤å®³æ•°å€¼ (Tick xxx)

            // è§£æå³è¾¹: ä¼¤å®³
            const isTick = rightPart.startsWith("Tick");
            
            // è§£æå·¦è¾¹: æ¥æº + æŠ€èƒ½
            // éš¾ç‚¹: "Sugar Riot 13 Mousse Mural" -> Source: Sugar Riot 13, Skill: Mousse Mural
            // ç­–ç•¥: 
            // 1. å¦‚æœå·¦è¾¹åŒ…å« "Multiple Enemies Combined DoTs"ï¼Œè¿™æ˜¯ç‰¹ä¾‹
            if (leftPart.includes("Multiple Enemies Combined DoTs")) {
                return {
                    time,
                    source: "Multiple Enemies",
                    skill: "Combined DoTs",
                    player: detectedPlayerName,
                    rawU: rawU,
                    isTick: true,
                    isCombinedSummary: true // æ ‡è®°è¿™æ˜¯æ€»æ±‡è¡Œ
                };
            }

            // 2. å°è¯•ä»å·²çŸ¥æŠ€èƒ½åº“åŒ¹é… (å€’åºåŒ¹é…æœ€é•¿æŠ€èƒ½å)
            let source = leftPart;
            let skill = "Unknown";
            
            let foundSkill = false;
            // å°† Set è½¬ä¸º Array å¹¶æŒ‰é•¿åº¦å€’åºï¼Œé˜²æ­¢ "Fire" åŒ¹é…äº† "Fire III" çš„ä¸€éƒ¨åˆ†
            const sortedSkills = Array.from(knownSkills).sort((a, b) => b.length - a.length);
            
            for (const s of sortedSkills) {
                if (leftPart.endsWith(s)) {
                    skill = s;
                    source = leftPart.substring(0, leftPart.length - s.length).trim();
                    foundSkill = true;
                    break;
                }
            }

            // 3. å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œä½¿ç”¨ç®€å•çš„ç©ºæ ¼åˆ†å‰²å…œåº• (å–æœ€åä¸€ä¸ªè¯ä¸ºæŠ€èƒ½)
            if (!foundSkill) {
                const parts = leftPart.split(/\s+/);
                if (parts.length > 1) {
                    skill = parts.pop();
                    source = parts.join(" ");
                } else {
                    skill = leftPart; // åªæœ‰ä¸€ä¸ªè¯ï¼Œæ—¢æ˜¯æ¥æºä¹Ÿæ˜¯æŠ€èƒ½? ä¸å¤ªå¯èƒ½ï¼Œæš‚ä¸”è¿™æ ·
                    source = "Unknown";
                }
            }

            return {
                time,
                source,
                skill,
                player: detectedPlayerName,
                rawU,
                isTick
            };
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
                
                // è·³è¿‡è¡¨å¤´
                let startIdx = 0;
                if (lines[0] && lines[0].includes("Time")) startIdx = 1;

                const dataLines = lines.slice(startIdx);

                // Pass 1: Scan
                preScanFile(dataLines);

                if (detectedPlayerName) {
                    playerBadge.classList.remove('hidden');
                    playerNameDisplay.innerText = detectedPlayerName;
                } else {
                    playerBadge.classList.add('hidden');
                }

                // Pass 2: Parse individual lines
                let rawParsedEvents = [];
                dataLines.forEach(line => {
                    const cols = parseCSVLine(line);
                    if (cols.length < 2) return;
                    const parsed = parseLine(cols[0], cols[1]);
                    if (parsed) rawParsedEvents.push(parsed);
                });

                // Pass 3: Grouping & Combined DoTs Logic
                parsedRows = processGroups(rawParsedEvents);
                
                renderTable();
            };
            reader.readAsText(file, 'UTF-8');
        }

        // æ­¥éª¤3: åˆ†ç»„ä¸èšåˆ
        function processGroups(events) {
            const output = [];
            // æŒ‰æ—¶é—´åˆ†ç»„
            const groups = {}; // { "00:00.000": [event1, event2...] }
            
            events.forEach(ev => {
                if (!groups[ev.time]) groups[ev.time] = [];
                groups[ev.time].push(ev);
            });

            const uniqueTimes = [...new Set(events.map(e => e.time))];

            uniqueTimes.forEach(time => {
                const groupEvents = groups[time];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ Combined DoTs çš„ Summary è¡Œ
                const summaryEvent = groupEvents.find(e => e.isCombinedSummary);

                if (summaryEvent) {
                    // å¦‚æœæœ‰ Combined DoTs
                    // é€»è¾‘: ç»Ÿè®¡è¯¥ç»„å†…æ‰€æœ‰ *å…¶ä»–* Tick è¡Œçš„ U å€¼ä¹‹å’Œ
                    let totalU = 0;
                    
                    groupEvents.forEach(e => {
                        if (!e.isCombinedSummary && e.isTick) {
                            totalU += e.rawU;
                        }
                    });

                    // æ„é€ æ–°çš„è¾“å‡ºè¡Œ
                    const finalU = totalU > 0 ? totalU : summaryEvent.rawU;

                    output.push({
                        time: time,
                        source: "Multiple Enemies",
                        skill: "Combined DoTs",
                        // 5. ä¸æ˜¾ç¤º Tick å‰ç¼€ï¼Œä»…æ˜¾ç¤ºæ•°å€¼
                        displayDamage: `${finalU}`,
                        rawU: finalU
                    });

                    // å¦‚æœç»„å†…æœ‰ éTick çš„äº‹ä»¶ (ä¾‹å¦‚åŒæ—¶åƒäº†ä¸€ä¸ªç›´ä¼¤AOE)ï¼Œä¿ç•™
                    groupEvents.forEach(e => {
                        if (!e.isCombinedSummary && !e.isTick) {
                            output.push({
                                time: e.time,
                                source: e.source,
                                skill: e.skill,
                                // 5. ä¸æ˜¾ç¤º Tick å‰ç¼€ï¼Œä»…æ˜¾ç¤ºæ•°å€¼
                                displayDamage: `${e.rawU}`,
                                rawU: e.rawU
                            });
                        }
                    });

                } else {
                    // æ²¡æœ‰ Combined DoTsï¼Œæ­£å¸¸è¾“å‡ºæ‰€æœ‰è¡Œ
                    groupEvents.forEach(e => {
                        output.push({
                            time: e.time,
                            source: e.source,
                            skill: e.skill,
                            // 5. ä¸æ˜¾ç¤º Tick å‰ç¼€ï¼Œä»…æ˜¾ç¤ºæ•°å€¼ (å³ä½¿æ˜¯ Tick è¡Œ)
                            displayDamage: `${e.rawU}`,
                            rawU: e.rawU
                        });
                    });
                }
            });

            return output;
        }

        function renderTable() {
            tableBody.innerHTML = '';
            
            if (parsedRows.length === 0) {
                controlPanel.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                emptyState.classList.remove('hidden');
                statusText.innerText = "æœªæ‰¾åˆ°ç¬¦åˆçš„æ•°æ®";
                return;
            }

            controlPanel.classList.remove('hidden');
            resultArea.classList.remove('hidden');
            emptyState.classList.add('hidden');
            statusText.innerText = `è§£æå®Œæˆï¼Œç”Ÿæˆ ${parsedRows.length} æ¡æ•°æ®`;

            parsedRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-blue-50/30 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 text-[var(--apple-text)] tabular-nums">${row.time}</td>
                    <td class="p-4 text-[var(--apple-text)] font-medium">${row.source}</td>
                    <td class="p-4 text-[var(--apple-text)]"><span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">${row.skill}</span></td>
                    <td class="p-4 text-[var(--apple-text)] text-right font-bold tabular-nums">${row.displayDamage}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function copyResults() {
            if (parsedRows.length === 0) {
                showToast("æ²¡æœ‰æ•°æ®å¯å¤åˆ¶", "error");
                return;
            }
            let text = "æ—¶é—´\tä¼¤å®³æ¥æº\tæŠ€èƒ½åç§°\tå®é™…ä¼¤å®³\n";
            parsedRows.forEach(row => {
                // æ­¤æ—¶ displayDamage å·²ç»æ²¡æœ‰ Tick å‰ç¼€äº†
                text += `${row.time}\t${row.source}\t${row.skill}\t${row.displayDamage}\n`;
            });

            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            } catch (err) {
                showToast("å¤åˆ¶å¤±è´¥", "error");
            }
            document.body.removeChild(textarea);
        }

        function resetAll() {
            parsedRows = [];
            detectedPlayerName = "";
            fileInput.value = '';
            controlPanel.classList.add('hidden');
            resultArea.classList.add('hidden');
            playerBadge.classList.add('hidden');
        }

        // Event Listeners
        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) processFile(e.target.files[0]);
            });
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('bg-blue-50', 'border-[var(--apple-blue)]');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-blue-50', 'border-[var(--apple-blue)]');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-blue-50', 'border-[var(--apple-blue)]');
                if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            const icon = toast.querySelector('i');
            msg.innerText = message;
            if (type === 'error') icon.className = 'ph ph-warning-circle text-red-400 text-lg';
            else icon.className = 'ph ph-check-circle text-green-400 text-lg';
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 2500);
        }
    </script>
</body>
</html>
